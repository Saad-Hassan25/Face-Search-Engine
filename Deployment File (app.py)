import gradio as gr
from deepface import DeepFace
import os
import zipfile
import cv2
import numpy as np

# --- CONFIGURATION ---
# List of zip files uploaded to Hugging Face Files
ZIP_FILES = ["part1.zip", "part2.zip"]

EXTRACT_ROOT = "my_gallery_extracted"

# The specific pickle file name generated by your local/Colab run.
# DeepFace looks for this specific filename to skip re-processing.
# Replace with your original one or it will generate error.
PKL_FILENAME = "ds_model_facenet512_detector_retinaface_aligned_normalization_base_expand_0.pkl"

# --- PART 1: SETUP (Runs once on startup) ---
def setup_database():
    """
    Extracts zip files and locates valid image directories.
    """
    db_paths = []
    
    for zip_file in ZIP_FILES:
        # Create a unique subfolder for each zip to prevent overwriting files
        subfolder_name = os.path.splitext(zip_file)[0]
        extract_path = os.path.join(EXTRACT_ROOT, subfolder_name)
        
        if not os.path.exists(extract_path):
            print(f"Found {zip_file}. Unzipping to {subfolder_name}...")
            try:
                if os.path.exists(zip_file):
                    with zipfile.ZipFile(zip_file, 'r') as zip_ref:
                        zip_ref.extractall(extract_path)
                    print(f"{zip_file} extracted!")
                else:
                    print(f"Error: {zip_file} not found. Please upload it to Files.")
                    continue
            except Exception as e:
                print(f"Error unzipping {zip_file}: {e}")
                continue
        else:
            print(f"{subfolder_name} already extracted.")

        # Locate the actual folder containing images/pkl inside the extraction
        for root, dirs, files in os.walk(extract_path):
            # We look for the PKL file to confirm this is a valid DB folder
            if PKL_FILENAME in files:
                print(f"   found database index at: {root}")
                db_paths.append(root)
            # Fallback: if pkl is missing but images exist, add path (search will be slower)
            elif any(f.lower().endswith(('.jpg', '.jpeg', '.png')) for f in files):
                if root not in db_paths:
                    db_paths.append(root)
            
    return db_paths

# Run setup immediately when app launches
valid_db_paths = setup_database()
print(f"Final Search Paths: {valid_db_paths}")

# --- PART 2: THE SEARCH LOGIC ---
def search_images(user_photo):
    """
    1. Saves the user photo.
    2. Searches through all extracted DB folders.
    3. Returns list of matching images.
    """
    if user_photo is None:
        return []
    
    print("üîç Search request received...")
    target_path = "temp_user_search.jpg"
    
    # Convert RGB (Gradio standard) to BGR (OpenCV standard) and save, this ensures color channels are correct for the model
    cv2.imwrite(target_path, cv2.cvtColor(user_photo, cv2.COLOR_RGB2BGR))

    found_images = []

    for folder in valid_db_paths:
        pkl_path = os.path.join(folder, PKL_FILENAME)
        
        if not os.path.exists(pkl_path):
            print(f"Warning: {PKL_FILENAME} missing in {folder}. DeepFace will scan from scratch (Slow).")

        try:
            # The Magic Search
            dfs = DeepFace.find(
                img_path=target_path,
                db_path=folder,
                model_name='Facenet512',
                distance_metric='cosine',
                detector_backend='retinaface', # Must match the detector used to create the PKL
                enforce_detection=False,
                align=True,
                silent=True
            )
            
            if len(dfs) > 0 and not dfs[0].empty:
                # Get the list of image paths found
                paths = dfs[0]['identity'].tolist()
                found_images.extend(paths)
                
        except Exception as e:
            print(f"Error searching {folder}: {e}")

    # Remove duplicates if any
    found_images = list(set(found_images))
    
    if not found_images:
        print("No matches found.")
        return []
        
    print(f"Found {len(found_images)} matches.")
    return found_images

# --- PART 3: THE USER INTERFACE ---
with gr.Blocks(title="Face Search AI") as demo:
    gr.Markdown("# üì∏ AI Photo Finder")
    gr.Markdown("Upload a selfie to find all your photos in the database.")
    
    with gr.Row():
        with gr.Column(scale=1):
            input_image = gr.Image(label="Your Selfie", type="numpy")
            search_button = gr.Button("üîç Find Me", variant="primary")
            
        with gr.Column(scale=3):
            # Gallery displays the actual found images
            output_gallery = gr.Gallery(label="Found Photos", columns=4, height=800, object_fit="contain")

    search_button.click(fn=search_images, inputs=input_image, outputs=output_gallery)

if __name__ == "__main__":
    demo.launch()
